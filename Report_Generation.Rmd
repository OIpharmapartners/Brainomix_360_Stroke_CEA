---
title: "The cost-effectiveness of an AI stroke imaging tool (B360S) - Dynamic Report (HTML)"
author: "Nichola Naylor (OI Pharma Partners Ltd), GPT-4o & GPT-5, Brainomix Ltd"
date: "2025 Analysis: 2023 Values"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float: true
    theme: readable
    df_print: paged
params:
  level:
    label: Results level
    value: National
    choices: [National, ISDN, Hospital]
  isdn:
    label: ISDN (used when Results level = ISDN)
    value: "— Select —"
    choices: ["— Select —", "Cheshire and Mersey", "East Midlands", "East of England (North)", "East of England (South)", "Frimley ICS and Surrey Heartlands", "Greater Manchester", "Humber Coast and Vale", "Islands", "Kent and Medway", "Lancashire and South Cumbria", "London", "North East and North Cumbria", "North Midlands", "South Yorkshire and Bassetlaw", "Sussex", "SW Peninsula", "Thames Valley (BOB)", "Wessex", "West Midlands", "West of England", "West Yorkshire and Harrogate"]
  hospital:
    label: Hospital (used when Results level = Hospital)
    value: "— Select —"
    choices: ["— Select —", "Addenbrooke's Hospital", "Barnet General Hospital", "Barnsley Hospital", "Basildon University Hospital", "Bedford Hospital", "Birmingham Heartlands Hospital", "Blackpool Victoria Hospital", "Bradford and Airedale SU", "Broomfield Hospital", "Calderdale Royal Hospital", "Charing Cross Hospital HASU", "Charing Cross Hospital SU - Nine South Ward", "Chelsea and Westminster Hospital", "Chesterfield Royal", "Colchester General Hospital", "Countess of Chester Hospital", "Croydon University Hospital", "Cumberland Infirmary", "Darent Valley Hospital", "Derriford Hospital", "Diana Princess of Wales Hospital Grimsby", "Doncaster Royal Infirmary", "Dorset County Hospital", "East Surrey Hospital", "Eastbourne District General Hospital", "Epsom Hospital", "Fairfield General Hospital", "Frimley Park Hospital", "Furness General Hospital", "Gloucestershire Royal Hospital", "Good Hope General Hospital", "Goole District Hospital", "Great Western Hospital Swindon", "Harrogate District Hospital", "Hereford County Hospital", "Hexham General Hospital", "Hillingdon Hospital", "Hinchingbrooke Hospital", "Homerton University Hospital", "Hull Royal Infirmary", "Invicta Ward Kent and Canterbury Hospital", "Ipswich Hospital", "James Cook University Hospital", "James Paget Hospital", "Jersey Health & Community Services Acute Episode", "John Radcliffe Hospital", "Kent and Canterbury Hospital", "King's College Hospital HASU", "King's College Hospital SU", "Kings Mill Hospital", "Kingston Hospital", "Leeds General Infirmary", "Leicester Royal Infirmary", "Leighton Hospital", "Lincoln County Hospital", "Lister Hospital", "Luton and Dunstable Hospital", "Maidstone District General Hospital", "Manchester Royal Infirmary", "Milton Keynes General Hospital", "Musgrove Park Hospital", "New Cross Hospital", "Newham General Hospital", "Noble's Hospital", "Norfolk and Norwich University Hospital", "North Bristol Hospitals", "North Devon District Hospital", "North Middlesex Hospital", "North Tyneside General Hospital", "Northampton General Hospital", "Northumbria Specialist Emergency Care Hospital HASU", "Northwick Park Hospital HASU", "Northwick Park Hospital SU", "Peterborough City Hospital", "Pilgrim Hospital", "Pinderfields Hospital", "Princess Royal Hospital Telford", "Princess Royal University Hospital HASU", "Princess Royal University Hospital SU", "Queen's Medical Centre - Nottingham", "Queen Alexandra Hospital Portsmouth", "Queen Elizabeth Hospital Edgbaston", "Queen Elizabeth Hospital Gateshead", "Queen Elizabeth Hospital Kings Lynn", "Queen Elizabeth the Queen Mother Hospital", "Queens Hospital Burton upon Trent", "Queens Hospital Romford HASU", "Queens Hospital Romford SU", "Rotherham Hospital", "Royal Albert Edward Infirmary", "Royal Berkshire Hospital", "Royal Blackburn Hospital", "Royal Bolton Hospital", "Royal Cornwall Hospital", "Royal Derby Hospital", "Royal Devon and Exeter Hospital", "Royal Free Hospital", "Royal Hallamshire Hospital", "Royal Hampshire County Hospital", "Royal Lancaster Infirmary", "Royal London Hospital HASU", "Royal London Hospital SU", "Royal Preston Hospital", "Royal Shrewsbury Hospital", "Royal Stoke University Hospital", "Royal Surrey County Hospital", "Royal Sussex County Hospital", "Royal United Hospital Bath", "Royal Victoria Infirmary", "Russells Hall Hospital", "Salford Royal Hospital", "Salisbury District Hospital", "Sandwell District Hospital", "Scunthorpe General Hospital", "Southampton General Hospital", "Southend Hospital", "Southport and Formby District General", "St George's Hospital HASU", "St George's Hospital SU", "St Helier Hospital", "St Mary's Hospital Newport", "St Peter's Hospital", "St Richards Hospital", "St Thomas Hospital", "Stepping Hill Hospital", "Sunderland Royal Hospital", "Tameside General Hospital", "Torbay Hospital", "Trafford General Hospital", "University College Hospital HASU", "University College Hospital SU", "University Hospital Aintree", "University Hospital Coventry", "University Hospital Lewisham", "University Hospital of North Durham", "University Hospitals Dorset Stroke Service", "University Hospitals of North Tees and Hartlepool", "Wansbeck General Hospital", "Warrington Hospital", "Watford General Hospital", "West Cumberland Hospital", "West Middlesex University Hospital", "West Suffolk Hospital", "Whipps Cross University Hospital", "Whiston Hospital HASU", "Whiston Hospital SU", "William Harvey Hospital", "Wirral Arrowe Park Hospital", "Worcestershire Royal Hospital", "Worthing Hospital", "Wycombe General Hospital", "Wythenshawe Hospital", "Yeovil District Hospital", "York Hospital"]

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Required
needed <- c("knitr","htmltools")
miss  <- needed[!sapply(needed, requireNamespace, quietly = TRUE)]
if (length(miss)) stop("Please install: ", paste(miss, collapse = ", "))

# HTML styling
opt_needed <- c("kableExtra")
opt_miss   <- opt_needed[!sapply(opt_needed, requireNamespace, quietly = TRUE)]
use_kex    <- length(opt_miss) == 0

# Load precomputed outputs
load("outputs/base_case_results.RData")     # -> base_case
load("outputs/network_results.RData")       # -> network_results (named list by ISDN)
load("outputs/hospital_results.RData")      # -> hospital_results (named list by Hospital)

# --- Table helpers ---
kbl <- function(x, cap = NULL, digits = 2, align = NULL) {
  tab <- knitr::kable(x, format = "html", caption = cap, digits = digits, align = align, table.attr='class="table table-bordered table-condensed table-hover"')
  if (use_kex) {
    tab <- kableExtra::kable_styling(
      tab, full_width = FALSE, position = "center",
      bootstrap_options = c("striped", "condensed", "hover", "responsive", "bordered")
    )
  }
  tab
}

kbl_wide <- function(x, cap = NULL, digits = 2) {
  tab <- knitr::kable(x, format = "html", caption = cap, digits = digits, table.attr='class="table table-bordered table-condensed table-hover"')
  if (use_kex) {
    tab <- kableExtra::kable_styling(
      tab, full_width = FALSE, position = "center",
      bootstrap_options = c("striped", "condensed", "hover", "responsive", "bordered")
    )
  } else {
    tab <- htmltools::HTML(paste0('<div style="font-size:90%;">', tab, '</div>'))
  }
  tab
}

# Fallback CSS to ensure borders/lines even without kableExtra
fallback_css <- "
table.table, table.kable-table, .table {
  border-collapse: collapse !important;
  border: 1px solid #ccc !important;
}
table.table th, table.table td,
table.kable-table th, table.kable-table td,
.table th, .table td {
  border: 1px solid #ccc !important;
  padding: 6px 8px !important;
}
caption { caption-side: top; font-weight: 600; padding-bottom: 6px; }
"

# Inject CSS into document
knitr::asis_output(paste0('<style>', fallback_css, '</style>'))

# --- Picker for results ---
pick_results <- function(level, hospital, isdn) {
  if (identical(level, "National")) {
    return(list(label = "National", res = base_case))
  }
  if (identical(level, "Hospital")) {
    if (identical(hospital, "— Select —")) stop("Please pick a Hospital in the parameters dialog.")
    if (!hospital %in% names(hospital_results)) stop("Selected hospital not found in outputs.")
    return(list(label = paste0("Hospital: ", hospital), res = hospital_results[[hospital]]))
  }
  if (identical(level, "ISDN")) {
    if (identical(isdn, "— Select —")) stop("Please pick an ISDN in the parameters dialog.")
    if (!isdn %in% names(network_results)) stop("Selected ISDN not found in outputs.")
    return(list(label = paste0("ISDN: ", isdn), res = network_results[[isdn]]))
  }
  stop("Unknown level: ", level)
}

# ---- Formatting helpers ----
format_numbers <- function(df) {
  cols_to_format <- setdiff(names(df)[sapply(df, is.numeric)], "LT_qol")
  for (col in cols_to_format) {
    df[[col]] <- formatC(df[[col]], format = "f", digits = 0, big.mark = ",")
  }
  # Ensure LT_qol shows 2 d.p. but remains excluded from 0-dp formatting
  if ("LT_qol" %in% names(df) && is.numeric(df[["LT_qol"]])) {
    df[["LT_qol"]] <- formatC(df[["LT_qol"]], format = "f", digits = 2, big.mark = ",")
  }
  df
}

rename_table_headers <- function(df) {
  new_names <- c(
    "intervention"        = "intervention (numbers)",
    "standard"            = "standard (numbers)",
    "unit.cost"           = "unit cost (£)",
    "LT_cost"             = "long-term cost (£)",
    "LT_qol"              = "long-term quality of life (QALYs)",
    "intervention_costs"  = "total intervention costs (£)",
    "standard_costs"      = "total standard costs (£)",
    "intervention_qol"    = "total intervention QALYs",
    "standard_qol"        = "total standard QALYs",
    "inc.cost"           = "Incremental Cost (£)",
    "inc.qol"             = "Incremental QALYs",
    "NMB"                 = "Net Monetary Benefit (£)"
  )
  names(df) <- ifelse(names(df) %in% names(new_names), new_names[names(df)], names(df))
  df
}



# Pull selected result set based on parameters
picked <- pick_results(params$level, params$hospital, params$isdn)
res    <- picked$res

# Apply column renaming and number formatting across relevant frames
res$process_results      <- rename_table_headers(format_numbers(res$process_results))
res$summary_data_all     <- rename_table_headers(format_numbers(res$summary_data_all))
res$incremental_results  <- rename_table_headers(format_numbers(res$incremental_results))
```

```{r report-meta, echo=FALSE}
htmltools::div(
  style = "background:#f7f7f7; padding:10px; border-radius:8px; margin-bottom:12px;",
  htmltools::HTML(sprintf("
  <strong>Author(s):</strong> %s<br/>
  <strong>Year of analysis:</strong> %s<br/>
  <strong>Citation:</strong> %s",
    params$authors, params$analysis_year, params$citation))
)
```

# Introduction
This report presents a cost-effectiveness analysis of a Brainomix 360 Stroke (B360S) AI software decision-support tool in England NHS hospitals.

For more detailed information on the model structure please refer to the associated publication: <em>[TO BE ADDED ONCE ACCEPTED]</em>.

# Notes
- Citation: [To be addd post-publication]
- Displays precomputed results from previously run analyses; no models are re-run in the compilation of this report.
- Use <strong>Knit ▼ → Knit with Parameters...</strong> to choose Level and (if needed) Hospital/ISDN from dropdowns.

# Selection
**Level:** `r params$level`  
**Scope:** `r picked$label`

# Results

## Process / Procedure numbers

In Table 1 below, unit costs represent the direct cost of performing the procedures, whilst long term costs and QALYs are the per-procedure impacts modelled over time, based on the distribution of patients on mRS scores. Values are rounded to the nearest value, and as such multiplying these may be different to the values computed with raw values and presented in Table 2. In Table 2, the cost of implementing the intervention is also included in total intervention costs.

Abbreviations: CTA - Computed Tomography Angiography , CTP – CT perfusion, MRI - perfusion magnetic resonance imaging, MT – mechanical thrombectomy, NCCT – non-contrast CT scan, IVT – intravenous thrombolysis.  

```{r}
# Split into two subtables for readability
tbl1a <- res$process_results[, 1:6]          # first 6 columns
tbl1b <- res$process_results[, c(1, 7:10)]   # first column + columns 7–10

# Reapply formatting using helpers (safe if already applied)
tbl1a <- rename_table_headers(format_numbers(tbl1a))
tbl1b <- rename_table_headers(format_numbers(tbl1b))

# Table 1 – first half
kbl_wide(tbl1a, cap = "Process / Procedure numbers – Part 1", digits = 0)

# Separator
knitr::asis_output("<br/>")

# Table 1 – second half
kbl_wide(tbl1b, cap = "Process / Procedure numbers – Part 2", digits = 0)
```

## Total Costs and QALYs

Negative costs are indicators of cost savings from procedures. For example, each MT has a net monetary saving due to the mRS benefits estimated to occur due to MT. 

```{r}
kbl(res$summary_data_all, cap = "Total costs and QALYs", digits = 2)
```

## Incremental results

Note that net monetary benefit (NMB) is calculated as:
\\[
\\mathrm{NMB} = (\\text{Incremental QALYs} \\times \\text{Willingness-to-pay}) - \\text{Incremental Costs}
\\]
We use a willingness-to-pay threshold of £20,000 per QALY gained, as recommended by NICE.

```{r}
kbl(res$incremental_results, cap = "Incremental results (intervention vs standard)", digits = 2)
```


